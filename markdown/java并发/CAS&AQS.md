## CAS&AQS

#### CAS(比较交换)

-   **概念**

    -   无锁原子算法
    -   CAS（V，E，N）V表示要更新变量的值，E表示预期值，N表示新值
    -   **CPU的原子指令**
        -   让CPU先进行比较两个值是否相等，然后原子地更新某个位置的值
        -   其实现方式是基于硬件平台的汇编指令

-   **特点**

    -   无锁非阻塞
        -   当多个线程同时使用CAS 操作一个变量时，只有一个会胜出
    -   性能高
        -   没有锁竞争带来的系统开销

-   **底层原理**

    -   **硬件保证**一个从语义上看起来**需要多次操作的行为只通过一条处理器指令**就能完成

-   **实现方式** 

    -   1.总线锁定
        -   1)处理器提供的一个 LOCK# 信号
        -   2)当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住，
        -   3)那么该处理器可以独占共享内存。


    -   2.缓存锁定
        -   1)内存区域如果**被缓存在处理器的缓存行中**，并且在**Lock 操作期间被锁定**
        -   2)当他**执行锁操作写回到内存**时，处理器不在总线上声言 LOCK# 信号，而是**修改内部的内存地址**
        -   3)并允许他**的缓存一致性机制**来**保证操作的原子性**
        -   **不能使用缓存锁定情况**
            -   1.当**操作的数据不能被缓存在处理器内部**，或操作的**数据跨多个缓存行**时
            -   2.处理器不支持缓存锁定
        -   只需要**保证在同一时刻对某个内存地址**的操作是原子性的
        -   缓存一致性机制可以保证同一个内存区域的数据仅能被一个处理器修改

-   **缺点**

    -   循环时间太长
        -   自旋CAS长时间地不成功，则会给CPU带来非常大的开销
        -   需要控制cpu自旋次数
    -   只能保证一个共享变量原子操作
        -   只能针对一个共享变量，如果是多个共享变量就只能使用锁了，
    -   ABA

    ​

#### AQS(AbstractQueuedSychronzier)同步发生器

-   **基本思想**
    -   通过内置FIFO同步队列来完成线程资源争夺的管理工作
    -   CLH同步队列
        -   ​

